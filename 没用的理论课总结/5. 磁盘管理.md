# 磁盘管理

## 1. 基本概念

- 扇区：盘片被分成许多扇形的区域。
- 磁道：盘片上以盘片中心为圆心，不同半径的同心圆
- 柱面：硬盘中，不同盘片相同半径的磁道所组成的圆柱。

每个磁盘有两个面，每个面都有一个磁头。

磁盘分类：

- 固定头磁盘：每条磁道都有一个磁头，磁头相对于盘片的径向方向固定。
- 移动头磁盘：磁头可以活动。

## 2. 磁盘的管理

### 2.1 磁盘初始化

在磁盘可以存储数据之前，必须将它分成扇区，以便磁盘控制器能够进行读写操作，这个过程为**低级格式化**（或称物理格式化）。

低级格式化为每个扇区使用特殊的数据结构，填充磁盘。每个扇区的数据结构通常由头部、数据区域（通常为 512B）和尾部组成。头部和尾部包含了一些磁盘控制器的使用信息。

### 2.2 分区

在可以使用磁盘存储文件之前，操作系统还要将自己的数据结构记录到磁盘上，分为两步：

- 第一步，将磁盘分为由一个或多个柱面组成的分区，每个分区的起始扇区和大小都记录在磁盘主引导记录的分区表中。
- 第二步，对物理分区进行逻辑格式化（创建文件系统），操作系统将初始的文件系统数据结构存储到磁盘上，这些数据结构包括空闲空间和已分配的空间以及一个初始为空的目录。

### 2.3 磁盘缺陷

硬盘实际扇区数比硬盘标签上标定的大：

- 一部分用于存储硬盘的固件（硬盘控制器使用）
- 一部分是用户存储数据的区域，即工作区，也就是硬盘标定容量的扇区
- 剩下的就是保留区，超过在固件里定义的硬盘容量的那些扇区就称为保留扇区

绝大多数磁盘都有一些缺陷扇区，因此映射时必须用磁盘上的其他空闲扇区来替代这些缺陷扇区。

- P 表：又称为永久缺陷列表，用于记录硬盘生产过程中产生的缺陷。
- G 表：又称为增长缺陷列表，用于记录硬盘使用过程中由于磁介质性能变弱而引起的缺陷。

> 缺陷扇区被加入 P 表后，硬盘不会再读写该扇区，而是将原读写该扇区的操作顺延到读写坏扇区的下一个扇区，该扇区以后的所有扇区的 LBA 值都发生了改变，原来保留扇区的一个扇区成为了硬盘的 LBAmax，所以坏道被加入 P 表后，硬盘需要进行一次厂家低格。

> 由于保留扇区在硬盘的内道，同时由于该扇区会导致硬盘的数据存储从物理上来说不连续了，当磁头读取该扇区的数据时需要移动较远的距离，代替坏扇区后，该 LBA 的读写速度会慢一些，所以我们说缺陷扇区加入 G 表后会影响硬盘的读写速度。

### 2.4 磁盘访问时间

- **寻道时间**：
	- 这是把磁臂（磁头）从当前位置移动到指定磁道上所经历的时间。该时间是启动磁盘的时间 $s$ 与磁头移动 $n$ 条磁道所花费的时间之和。
	- $T_s＝ m × n + s$
- **旋转延迟时间**：
	- 假设 $r$ 为旋转速度，$T_r= \frac{1}{2r}$
- **传输时间**：
  - 指把数据从磁盘读出，或向磁盘写入数据所经历的时间，大小与每次所读/写的字节数 $b$，旋转速度 $r$ 以及磁道上的字节数 $N$ 有关。
  - $T_t＝\frac{b}{rN}$

## 3. 磁盘调度算法

### 3.1 先来先服务(FCFS)

根据请求访问磁盘的先后顺序进行调度，磁盘臂移动距离可能较长。

### 3.2 最短寻道时间优先(SSTF)

每次调度选择与当前磁头所在磁道距离最近的磁道，以便每次的寻道时间最短。

磁头会总是在中间附近（磁头粘粘），因为统计上移动最短。远处的磁道一直无法访问，会饿死。

### 3.3 扫描/电梯算法(SCAN)

维护磁头的方向位。当一个请求处理完毕后，如果方向向上，磁盘臂移到下一个更高的未完成请求，直到到达盘面的最高点，再改变方向，向下移动。

特点：

- 对内部和外部磁道的请求更优先。
- 完成请求方差大：最坏情况需要两次完整扫描才得到服务

### 3.4 循环扫描算法(CSCAN)

到达最高编号柱面后，移动到最低编号柱面。将最低编号柱面看做最高柱面的相邻柱面。

### 3.5 LOOK算法

对 SCAN 和 CSCAN 的改进，磁头移动时只需要到达最远端的一个请求即可，不必到达磁盘端点。

### 3.6 N-Step-SCAN算法

将请求分成长度为 N 的子序列。后续请求不会进入长度为 N 的已满请求序列中，所以最多
N 次就能够完成——避免饥饿

N 很大类似SCAN；N＝1类似FCFS

缺点：N 难以确定，随着负载增加，N 增加。

### 3.7 FSCAN算法

将磁盘请求队列分为两个子队列，一个是当前所有请求队列，按照 SCAN 算法处理，另一个是扫描期间新出现的请求汇合成另一个子队列。

## 4. RAID

RAID 即廉价磁盘冗余阵列，其基本思想就是把多个相对便宜的硬盘组合起来，成为一个硬盘阵列组，使性能达到甚至超过一个价格昂贵、容量巨大的硬盘。

RAID 采用的技术有：

- 条带化：将一块连续的数据分成很多小部分并把他们分别存储到不同磁盘上。
	- 优点：并行存取，性能好，磁盘负载均衡。
	- 缺点：可靠性略差、不同 IO 请求需要排队
- 镜像：数据完全拷贝一份。
	- 优点：可靠性高。
	- 缺点：存储开销大。
- 校验：数据通过某种运算（异或）得出，用以检验该组数字的正确性
	- 优点：可靠性高，快速恢复。
	- 缺点：额外存储开销。

RAID 分级如下：

| 级别 | 说明                                                         | 特点                                  | 磁盘数量     | 最少磁盘数量 |
| ---- | ------------------------------------------------------------ | ------------------------------------- | ------------ | ------------ |
| 0    | 条带化                                                       | 速度加倍，可靠性减半，容量不变        | n            | 2            |
| 1    | 镜像                                                         | 速度不变，可靠性加倍，容量减半        | n*2          | 2            |
| 0+1  | 组内条带化，组间镜像                                         | 速度加倍，可靠性加倍，容量减半        | n*2          | 4            |
| 1+0  | 组内镜像，组间条带化                                         | 速度加倍，可靠性加倍，容量减半        | 2*n          | 4            |
| 2    | 海明码校验                                                   | 校验独立存储，数据位交叉，纠正1个盘错 | $n+log_2(n)$ | 7            |
| 3    | 奇偶校验                                                     | 校验独立存储，数据位交叉，容1块盘错   | n+1          | 3            |
| 4    | 奇偶校验                                                     | 校验独立存储，数据块交叉，容1块盘错   | n+1          | 3            |
| 5    | 奇偶校验，将数据和校验都分布在<br>各个磁盘中，没有专门的奇偶校验驱动器 | 校验独立存储，数据块交叉，容1块盘错   | n+1          | 3            |
| 6    | 奇偶校验，双维校验                                           | 校验独立存储，数据块交叉，容2块盘错   | n+2          | 4            |

## 5. 提高 I/O 速度的方法

- 选择性能好的磁盘
- 并行化
- 采用适当的调度算法
- 设置磁盘高速缓冲区

## 5. 固态硬盘

固态硬盘（SSD）是基于闪存技术的存储器。

闪存(Flash)分类：

- NOR
- NAND

对比如下：

NOR 的地址线足够多，且存储单元是并列排布，可以实现一次性的直接寻址。另外，由于 NOR 的数据线宽度很大，即使容量增大，它的数据寻址时间基本上是一个常量，而 NAND 则比较困难。

NAND 的地址分为三部分：块号、块内页号、页内字节号。一次数据访问，NAND 一般是经过三次寻址，先后确定块号、块内页号和页内字节号，至少占用三个时钟周期，因此随机字节读速度慢。

读取速度： NOR 比 NAND 快

写入和擦除速度：NAND 快于 NOR

产品成本：NOR 每MB成本是NAND的四倍

擦写寿命：Nor 十万次，NAND 一百万次