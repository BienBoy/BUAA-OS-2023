# 文件系统

## 1. 文件系统的概念

### 1.1 定义

文件系统是操作系统中统一管理信息资源的一种软件，管理文件的存储、检索、更新，提供安全可靠的共享和保护手段，并且方便用户使用。

### 1.2 主要任务

- 统一管理磁盘空间，实施磁盘空间的分配与回收。
- 实现文件的按名存取：名字空间$\xrightarrow{映射}$磁盘空间。
- 实现文件信息的共享，并提供文件的保护、保密手段。
- 向用户提供一个方便使用、易于维护的接口，并向用户提供有关统计信息。
- 提高文件系统的性能。
- 提供与IO系统的统一接口。

## 2. 文件

### 2.1 文件控制块和索引结点

#### 1. 文件的属性

除文件数据外，保存的其他与文件相关的信息，如：所有者，创建时间等，这些信息被称为文件属性或文件元数据。

文件属性通常包括：

- 名称
- 类型
- 创建者
- 所有者
- 位置
- 大小
- 保护
- 创建时间、最后一次修改时间和最后一次存取时间

#### 2. 文件控制块

文件控制块（FCB）是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。

FCB 的有序集合称为文件目录，一个 FCB 就是一个文件目录项。

FCB 主要包含以下信息：

- 基本信息：文件名、物理位置、逻辑结构、物理结构等。
- 存取控制信息：文件所有者的存取权限、核准用户的存取权限以及一般用户的存取权限
- 使用信息：创建时间、上次修改时间等。

#### 3. 索引结点

UNIX 等系统采用文件名和文件描述信息分开的方法，文件描述信息单独形成一个称为**索引结点**的数据结构，简称 **i结点** (inode)。

### 2.2 逻辑结构

#### (1) 无结构文件（流式文件）

构成文件的基本单位是字符。文件是有逻辑意义、无结构的一串字符的集合。

#### (2) 有结构文件（记录式文件）

文件由若干记录组成，可以按记录进行读写、查找等操作。每条记录有其内部结构。

组织形式有以下几种：

##### 1. 顺序文件

记录都是顺序排列的，排列的方式有：

- 串结构：记录间的顺序与关键字无关，通常按存入时间排序。
- 顺序结构：按照记录的关键字排序，因此，可以应用二分查找检索。

记录的长度可以为定长，也可为变长：

- 对于定长的记录，第 $i$ 条记录的首地址为：$A_i=i\times L$，$L$ 为单条记录的长度
- 对于变长的记录，第 $i$ 条记录的首地址必须遍历前 $i-1$ 条记录获得：$A_i=\sum_{i=0}^{i-1}L_i+1$

##### 2. 索引文件

建立索引表，记录每条记录的首地址及其长度。索引表按关键词排序，其本身可视为一个定长记录的顺序文件。

##### 3. 索引顺序文件

顺序文件和索引文件的结合。

将顺序文件的记录分为若干组，建立一张索引表，记录每组第一个记录的首地址、关键词。

可以建立多级索引。

### 2.3 物理结构

#### (1) 连续分配

连续分配的方法要求每个文件在磁盘上占有一组连续的物理块。

优点：

- 实现简单
- 支持顺序存取和随机存取
- 顺序和随机存取时速度较快

缺点：

- 文件长度不易动态增加
- 容易产生外碎片，空间利用不充分
- 创建文件时要求给出文件大小，用户不方便

#### (2) 链接/串联分配

##### 1. 隐式链接

目录项中含有文件第一块和最后一块的地址。每个文件对应一个磁盘块的链表，磁盘块离散分布，除最后一个磁盘块，每个磁盘块均含有指向文件下一个所在磁盘块的指针。

优点：

- 空间利用率高，能较好的利用辅存空间
- 文件动态扩充和修改容易
- 顺序存取效率高

缺点：

- 随机存取效率太低
- 可靠性问题，如指针出错将导致文件数据丢失
- 链接指针占用一定的空间

##### 2. 显示链接（使用内存表的串联文件结构）

把用于链接文件各物理块的指针，从每个物理块的末尾提取出来，显式地存放在内存的一张链接表中。该表在整个磁盘中仅设置一张，称为文件分配表（FAT）。

FAT 在系统启动时将被读入内存。

优点：

- 不用将数据和地址一起保存
- 随机访问更加快速

缺点：

- 整个FAT必须在内存中
- 非常占用内存空间

##### 3. 索引分配

每个文件关联一个 index node(i-node) 数据结构，记录文件属性和每个物理块的地址。

UNIX 系统采用多级间接索引结构，对小型文件采用直接索引，对大型文件采用间接索引，从而，既保证绝大多数的文件有高的存取效率，又能适应存取一些大型文件（既保证了文件系统的高效率，又使其有很宽的适应面）。

![inode](./imgs/inode.png)

## 3. 目录

### 3.1 目录的基本概念

FCB 的有序集合称为文件目录，一个 FCB 就是一个文件目录项。

### 3.2 目录结构

#### (1) 单级目录结构

在整个文件系统中只建立一张目录表，每个文件占一个目录项。

优点：结构简单。

缺点：

- 文件多时，目录检索时间长
- 文件不能重名
- 不便于实现共享

#### (2) 两级目录结构

将文件目录分为主文件目录和用户文件目录两级。

主文件目录项记录用户名及相应的用户文件目录所在的存储位置。用户文件目录项记录该用户文件的 FCB 信息。

优点：

- 提高检索速度
- 解决了多用户间的文件重名问题
- 可以在目录上实现访问限制

缺点：缺乏灵活性，不能对文件分类。

#### (3) 树形目录结构

在较高的目录级，其目录项为下一级目录名以及一个指向其目录的指针。

在最后一级目录，这个指针指向文件的物理地址。

相关概念：

- 绝对路径：从根目录出发的路径
- 当前目录：也称工作目录，用户可以指定一个目录作为当前的工作目录
- 相对路径：相对当前目录的路径

优点：

- 层次清楚，便于对文件分类管理
- 便于对文件的保护
- 可解决文件重名问题
- 查找速度快

缺点：目录级别太多时，会增加路径检索时间

### 3.3 目录实现

#### (1) 目录项的内容

- 直接法：目录项存放文件名和相应的 FCB。
- 间接法：目录项存放文件名和相应的 FCB 的地址。

#### (2) 处理长文件名

常用实现方法有：

- 在目录项中，将文件名的长度固定为 255 个字符。缺点：浪费空间，很少文件用很长的名字。
- 每个目录项的长度可变，分为三部分：目录项长度、文件的属性信息（此两项长度固定）、文件名（长度可变）。缺点：文件被删除后，该目录项所占用的空间不太好回收利用。
- 目录项本身的长度固定，把长度可变的文件名统一放在**目录文件**的末尾，目录项中存放文件名的存放地址。

#### (3) 目录的检索方法

- 顺序查询
- 哈希

### 3.4 文件共享

#### (1) 基于索引结点的共享方式（硬链接）

使用索引结点，目录项中记录文件名和索引结点的地址，不同目录项可以指向同一索引结点，实现共享。

删除单一目录项不会删除索引结点，只有指向索引结点的指针数为 0 时，索引结点才会被真正删除。

#### (2) 利用符号链实现文件共享（软链接）

创建一种特殊的文件——LINK 文件，其中存放共享文件的地址。

当打开 LINK 文件时，操作系统会读取其中存放的地址，去打开地址对应的文件。

### 3.5 文件保护

#### (1) 建立副本

把同一个文件保存到多个存储介质上（同类或不同类）。

优点：方法简单。

缺点：设备费用和系统开销增大。

适用于短小且极为重要的文件。

#### (2) 定时转储

每隔一定时间把文件转储到其他存储介质上，当文件发生故障，就用转储的文件来复原，把有故障的文件恢复到转储时刻文件的状态。

#### (3) 文件的存取控制

文件保护机制用于：

- 防止未被核准的用户存取文件
- 防止一个用户冒充另一个用户来存取
- 防止核准用户（包括文件主）误用文件

存取权限验证步骤：

- 审定用户的权限
- 比较用户的权限与本次存取要求是否一致
- 将存取要求和被访问文件的保密性比较，看是否有冲突

存取控制的实现方案：

- 存取控制矩阵
- 存取控制表
- 用户权限表
- 口令

## 4. 文件系统

### 4.1 文件系统结构

一种可能的文件系统结构如下：

#### (1) I/O 控制

包括设备驱动程序和中断处理程序，在内存和磁盘系统之间传输信息。

#### (2) 基本文件系统

相对应的设备驱动程序发送通用命令，以读取和写入磁盘的物理块。

该层也管理内存缓冲区，并保存各种文件系统、目录和数据块的缓存。

#### (3) 文件组织模块

组织文件及其逻辑块和物理块。文件组织模块可以将逻辑块地址转换为物理块地址。

#### (4) 逻辑文件系统

用于管理元数据信息。元数据包括文件系统的所有结构，而不包括实际数据。

逻辑文件系统管理目录结构，以便根据给定的文件名称为文件组织模块提供所需要的信息。

逻辑文件系统通过文件控制块（FCB）来维护文件结构。此外，还负责文件保护。

### 4.2 文件系统布局

#### (1) 文件系统在磁盘中的结构

文件系统存放在磁盘上，磁盘被划分为一个或多个分区，每个分区有一个独立的文件系统。

文件系统可能包括的信息有：启动所存储的操作系统的方式、总块数、空闲块数量及位置、目录结构以及各个具体的文件等。

一种可能的文件系统布局：

- 主引导记录（MBR）：位于磁盘的 0 号扇区，用来引导计算机。MBR 后面是分区表，记录每个分区的起始和结束地址。其中的一个分区被标记为活动分区，计算机启动时，BIOS 读入并执行 MBR。MBR 会读入活动分区的第一块——引导块。
- 引导块：存储用于启动该分区中的操作系统的程序。每个分区都从一个引导块开始。
- 超级块：包含文件系统的所有关键信息。在计算机启动或该文件系统被首次使用时，超级块会被读入内存。
- 文件系统中空闲块的管理信息：通过位图或链表管理。
- 目录和文件

#### (2) 文件系统在内存中的结构

内存中的信息用于管理文件系统并通过缓存来提高性能。这些数据在安装文件系统时被加载，正在文件系统操作期间被更新，在卸载时被丢弃。这些信息可能包括：

- 内存中的安装表，包含每个已安装文件系统分区的有关信息。
- 内存中的目录结构的缓存包含最近访问目录的信息。对于安装分区的目录，它可以包括一个指向分区表的指针。
- 整个系统的打开文件表，包含每个打开文件的 FCB 副本及其他信息。
- 每个进程的打开文件表，包含一个指向整个系统的打开文件表中的对应条目的指针，以及其他信息。

### 4.3 磁盘空闲空间管理

#### (1) 空闲表法

将外存空间中的一个连续未分配区域称为“空闲区”。空闲表中的每个表项对应一个空闲区，它适用于连续文件结构。

实例如下：

| 序号 | 第一空闲盘块号 | 空闲盘块数 |
| :--: | :------------: | :--------: |
|  1   |       2        |     4      |
|  2   |       9        |     3      |
|  3   |       15       |     5      |
|  ……  |       ……       |     ……     |

空闲表法类似内存管理的动态分区分配。

#### (2) 空闲链表法

将所有的空闲盘区拉成一条空闲链。

根据构成链的基本元素的不同，可有两种链表方式：

- **空闲盘块链**：将磁盘上的所有空闲存储空间，以盘块为基本元素拉成一条链。优点是用于分配和回收的过程非常简单；缺点
	是空闲盘块链可能很长。
- **空闲盘区链**：将磁盘上的所有空闲盘区（每个盘区可包含若干个盘块）拉成一条链。每个盘区上除了含有用于指示下一个空闲盘区的指针外
	，还应标有指明本盘区大小（盘块数）的信息。这方法分配和回收过程较复杂，但空闲盘区链较短。

#### (3) 位示图法

位示图法利用二进制的一位来表示磁盘中一个盘块的使用情况，磁盘上所有的盘块都有一个二进制位与之对应。为 0 表示空闲；1 表示已分配。

#### (4) 成组链接法

在 UNIX/Linux 系统中，将空闲块分成若干组，每 100 个空闲块为一组，
每组的第一个空闲块记录了下一组空闲块的物理盘块号和空闲块总数。
如果一组的第一个空闲块号等于 0，意味着该组是最后一组。

### 4.4 虚拟文件系统

虚拟文件系统（VFS）为用户提供文件系统操作的统一接口，屏蔽不同文件系统的差异和操作细节。用户程序可以通过 VFS 提供的统一调用函数来操作不同文件系统的文件，而无需考虑具体的文件系统和实际的存储介质。

为了实现 VFS，Linux 主要抽象了四种对象类型：

- 超级块对象：表示一个已安装的特定文件系统。对应于磁盘上特定扇区的文件系统超级块，用来存储已安装文件系统的元信息，即文件系统的基本属性信息，如：文件系统类型、文件系统基本块大小、文件系统所挂载的设备、操作方法指针等。
- 索引结点对象：表示一个特定的文件。文件系统处理文件所需要的所有信息都存放在索引结点对象中。索引文件对应文件是唯一的。只有当文件被访问时，才在内存中创建索引结点对象，复制磁盘索引结点中的一些数据。索引结点对象中含有脏位，表示是否被修改。此外，索引结点对象还提供了许多操作接口。
- 目录项对象：表示一个特定的目录项。目录项对象是一个路径的组成部分。目录项对象在磁盘中没有对应的数据结构。
- 文件对象：表示一个与进程相关的已打开文件。

Linux 将目录作为文件对象处理，文件操作可以同时应用于文件和目录。

### 4.5 分区和安装

一个磁盘可别划分为多个分区，每个分区都可用于创建单独的文件系统，每个分区还可包含不同的操作系统。

分区可以没有文件系统，在没有合适的文件系统时，也可直接使用原始磁盘。如：UNIX 交换空间可以直接使用原始磁盘。
